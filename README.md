# 元梦之星农场自动化脚本 v2.4

## 项目简介
这是一个为元梦之星农场设计的自动化脚本，使用ADB命令模拟WASD按键操作，实现精确的角色移动控制。

## 核心特性
- ✅ 使用 `adb shell input keyevent --longpress` 实现稳定的按键控制
- ✅ 支持移动、点击、滑动的混合操作
- ✅ 触摸参数记录器，自动生成命令序列
- ✅ 配置文件管理，支持多个预设序列

## 环境要求

### PC端环境
1. **ADB工具**: 确保ADB已安装并添加到系统PATH
2. **Python 3.6+**: 运行脚本需要Python环境
3. **Android设备**: 开启USB调试模式并连接到电脑

### 手机端环境
1. **Android设备**: Android 4.0+
2. **Root权限**: 需要设备已root，使用Magisk
3. **终端应用**: 使用 Termux

## 快速开始

### PC端使用

#### 1. 检查ADB连接
```bash
adb devices
```
确保显示你的设备状态为 `device`

#### 2. 运行主脚本
```bash
python move_debugger.py
```

#### 3. 功能说明

**主要功能菜单：**
1. **移动测试** - 测试单个方向的移动
2. **统一命令执行** - 融合移动/点击/滑动的混合操作
3. **触摸参数记录器** - 记录触摸操作并生成命令
4. **查看设备状态** - 显示设备信息

### 手机端使用

#### 1. 部署脚本文件
将 `auto_game.sh` 和 `config_commands.txt` 复制到手机存储中

#### 2. 设置执行权限
```bash
chmod +x auto_game.sh
```

#### 3. 基本使用
```bash
# 查看配置
sh auto_game.sh -c

# 执行所有命令行（默认行为）
sh auto_game.sh

# 执行指定行命令
sh auto_game.sh 1

# 显示帮助
sh auto_game.sh -h
```

## 手机端部署方法

### 使用Magisk + Termux

1. **安装Magisk**
   - 确保设备已root并安装Magisk

2. **安装Termux**
   - 从F-Droid下载安装Termux

3. **获取Root权限**
   ```bash
   # 在Termux中安装tsu
   pkg install tsu
   su
   ```

4. **上传脚本文件**
   - 将脚本文件复制到手机存储
   - 推荐路径：`/data/data/com.termux/files/home/ymzx/`

5. **设置执行权限**
   ```bash
   chmod +x auto_game.sh
   ```

## 统一命令语法

### 移动命令
```
方向键 + 次数
```
- `W5` - 向上移动5次
- `A3 D2` - 向左3次，然后向右2次
- 方向键：W(上) A(左) S(下) D(右)

### 点击命令
```
x,y坐标
```
- `540,960` - 点击坐标(540, 960)

### 滑动命令
```
SWIPE:x1,y1,x2,y2,duration
```
- `SWIPE:800,500,800,300,500` - 从(800,500)滑动到(800,300)，持续500ms

### 间隔时间参数
```
数字 + ms后缀
```
- `500ms` - 等待500毫秒
- `1000ms` - 等待1000毫秒（1秒）

### 混合命令示例
- `W3 540,960` - 向上3次然后点击中心
- `W3 1000ms 540,960` - 向上3次→等待1000ms→点击中心
- `A2 500ms SWIPE:800,600,800,300,400 D1` - 向左2次→等待500ms→滑动→向右1次

## 配置参数

### 时间间隔参数
```bash
# 时间间隔参数 (单位: 秒)
DEFAULT_INTERVAL=0.8    # 命令之间的默认间隔 (800ms)
KEY_INTERVAL=0.8        # 按键之间的间隔 (800ms)
SEQ_INTERVAL=2.0        # 命令序列之间的间隔 (2000ms)
```

### 配置文件格式
配置文件 `config_commands.txt` 的格式：
1. 每行一个命令序列
2. 以`#`开头的行会被视为注释
3. 空行会被自动忽略

例如：
```
# 农场第六列
2160,980 1500ms D3 1990,600 2000,860 SWIPE:2000,500,2090,500,500

# 简单移动测试
W2 A2 S2 D2
```

## 触摸参数记录器

### 功能说明
- **自动记录**: 记录触摸操作并生成对应命令
- **智能识别**: 自动区分点击和滑动操作
- **坐标转换**: 自动处理触摸传感器坐标到屏幕坐标的转换
- **时间间隔**: 自动记录操作之间的时间间隔

### 使用流程
1. 在PC端运行 `python move_debugger.py`
2. 选择 "3. 触摸参数记录器"
3. 选择 "3. 开始记录触摸事件"
4. 在手机屏幕上进行操作
5. 按 Ctrl+C 停止记录
6. 查看和测试生成的命令

## 故障排除

### PC端常见问题
1. **角色不移动**
   - 确认使用的是longpress方法
   - 检查游戏是否处于可移动状态

2. **ADB连接失败**
   - 检查USB调试是否开启
   - 确认ADB驱动是否正确安装

### 手机端常见问题
1. **权限被拒绝**
   ```bash
   # 解决方案: 确保有root权限
   su
   ```

2. **命令不存在**
   ```bash
   # 检查input命令是否可用
   which input
   ```

3. **脚本无法执行**
   ```bash
   # 检查文件权限
   chmod +x auto_game.sh
   ```

## 技术原理

### 为什么使用--longpress？
经过测试发现，普通的keyevent无法让游戏角色移动，只有longpress方法才能被游戏识别为有效的按键输入。

### 键位映射
```
W键: keycode=51  # 向上移动
A键: keycode=29  # 向左移动
S键: keycode=47  # 向下移动
D键: keycode=32  # 向右移动
```

## 文件说明

### 核心文件
- `move_debugger.py` - PC端主脚本
- `auto_game.sh` - 手机端执行脚本
- `config_commands.txt` - 命令配置文件

### 生成的文件
- `move_debugger.log` - 详细的操作日志（PC端）
- `touch_commands.txt` - 触摸命令记录

## 注意事项

### 使用建议
1. **首次使用前**
   - 先在测试环境验证脚本效果
   - 确认所有坐标和操作的准确性

2. **使用过程中**
   - 保持游戏处于前台状态
   - 避免在脚本执行时手动操作

3. **安全使用**
   - 遵守游戏服务条款
   - 合理控制自动化频率

---

**项目维护**: 专注于root+magisk环境的稳定运行

## 更新记录

### 2025-08-18 - 触摸事件记录器优化 v2.4.2
- **修改内容**: 优化触摸事件记录器，添加真实时间间隔记录功能
- **负责人**: Claude Code Assistant

### 2025-08-12 - 修复触摸事件识别问题 v2.4.1
- **修改内容**: 修复TouchEventRecorder类的process_touch_event函数竞态条件问题
- **负责人**: Claude Code Assistant

### 2025-07-29 - 完成OOP架构重构 v2.4
- **修改内容**: 完成项目OOP架构重构，优化代码结构和组件管理
- **负责人**: Claude Code Assistant